<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Startup Allocation System</title>
    <!-- Use the Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 900px;
        }
        .btn-select {
            transition: transform 0.1s ease-in-out, background-color 0.2s, color 0.2s;
        }
        .btn-select.selected-demo {
            background-color: #4f46e5;
            color: white;
        }
        .btn-select.selected-private {
            background-color: #9333ea;
            color: white;
        }
        .btn-select:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex items-center justify-center min-h-screen">
    <div class="container mx-auto bg-white shadow-xl rounded-2xl p-6 sm:p-10 border border-gray-200">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-2">Startup Allocation Ballot</h1>
            <p class="text-gray-600 text-base sm:text-lg">Select exactly 10 for Demo Day and 20 for Private Pitch.</p>
        </header>

        <!-- Name Input and Validation -->
        <div id="name-section" class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-8">
            <input id="voter-name-input" type="text" placeholder="Enter your name" class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <button id="start-voting-btn" class="px-6 py-3 bg-indigo-600 text-white font-bold rounded-full shadow-lg hover:bg-indigo-700 transition duration-300">Start Voting</button>
        </div>
        <div id="loading-section" class="text-center italic hidden">Checking name...</div>

        <!-- User Info & Counters -->
        <div id="app-counters" class="flex flex-col sm:flex-row justify-between items-center bg-gray-100 rounded-xl p-4 mb-6 shadow-inner hidden">
            <div id="user-info" class="text-xs text-gray-500 mb-2 sm:mb-0">
                <p>Authenticated as: <span id="voter-name-display" class="font-semibold"></span></p>
            </div>
            <div class="flex space-x-4">
                <div class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-full text-sm">
                    Demo Day: <span id="demo-day-count">0</span> / 10
                </div>
                <div class="bg-purple-600 text-white font-bold py-2 px-4 rounded-full text-sm">
                    Private Pitch: <span id="private-pitch-count">0</span> / 20
                </div>
            </div>
        </div>

        <!-- Startup List Container -->
        <div id="startup-list" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 hidden">
            <!-- Startups will be rendered here by JavaScript -->
        </div>

        <!-- Submit Button -->
        <div id="submit-section" class="flex justify-center mb-8 hidden">
            <button id="submit-btn" disabled
                class="w-full sm:w-auto px-8 py-4 bg-gray-400 text-white font-bold text-lg rounded-full shadow-lg cursor-not-allowed">
                Submit Selections
            </button>
        </div>

        <!-- Message Box for user feedback -->
        <div id="message-box" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4" onclick="this.classList.add('hidden')">
            <div class="bg-white p-6 rounded-xl shadow-2xl text-center max-w-sm w-full transform scale-95 transition-transform duration-300" onclick="event.stopPropagation()">
                <p id="message-text" class="text-lg font-medium text-gray-700 mb-4"></p>
                <button onclick="document.getElementById('message-box').classList.add('hidden')" class="px-6 py-2 bg-indigo-600 text-white rounded-full font-semibold hover:bg-indigo-700">OK</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Your Firebase config object has been included below.
        const firebaseConfig = {
        apiKey: "AIzaSyB3eQjDm-90XRwcekCrip1QJG56nbEpkMU",
        authDomain: "startup-voting-application.firebaseapp.com",
        projectId: "startup-voting-application",
        storageBucket: "startup-voting-application.firebasestorage.app",
        messagingSenderId: "920845970735",
        appId: "1:920845970735:web:d31d6850da12f8c31285da"
        };
        
        // --- DO NOT EDIT BELOW THIS LINE ---
        
        // Global variables provided by the Canvas environment
        const appId = firebaseConfig.projectId;
        
        // Use a self-invoking function to avoid global variable pollution
        (async function() {
            // Define the list of 50 startups
            const startups = [];
            for (let i = 1; i <= 50; i++) {
                startups.push(`Startup ${i}`);
            }

            // Get DOM elements
            const nameSectionEl = document.getElementById('name-section');
            const voterNameInputEl = document.getElementById('voter-name-input');
            const startVotingBtn = document.getElementById('start-voting-btn');
            const loadingSectionEl = document.getElementById('loading-section');
            const appCountersEl = document.getElementById('app-counters');
            const voterNameDisplayEl = document.getElementById('voter-name-display');
            const startupListEl = document.getElementById('startup-list');
            const submitSectionEl = document.getElementById('submit-section');
            const submitBtn = document.getElementById('submit-btn');
            const demoDayCountEl = document.getElementById('demo-day-count');
            const privatePitchCountEl = document.getElementById('private-pitch-count');
            const messageBoxEl = document.getElementById('message-box');
            const messageTextEl = document.getElementById('message-text');

            let db;
            let voterName = '';
            let demoDayPitches = new Set();
            let privatePitches = new Set();
            let hasVoted = false;

            /**
             * Displays a message box with the given text.
             * @param {string} message The message to display.
             */
            function showMessage(message) {
                messageTextEl.textContent = message;
                messageBoxEl.classList.remove('hidden');
                messageBoxEl.classList.add('flex');
            }

            /**
             * Renders the list of startups with selection buttons.
             */
            function renderStartups() {
                startupListEl.innerHTML = '';
                startups.forEach(startup => {
                    const card = document.createElement('div');
                    card.classList.add('bg-white', 'p-4', 'rounded-xl', 'shadow-md', 'border', 'border-gray-200', 'flex', 'flex-col', 'justify-between');
                    card.dataset.startup = startup;

                    const title = document.createElement('h3');
                    title.classList.add('text-lg', 'font-bold', 'text-gray-800', 'truncate', 'mb-3');
                    title.textContent = startup;

                    const btnContainer = document.createElement('div');
                    btnContainer.classList.add('flex', 'flex-wrap', 'gap-2');

                    const voteOptions = ['Demo Day Pitch', 'Private Pitch', 'Neither'];
                    voteOptions.forEach(option => {
                        const button = document.createElement('button');
                        button.textContent = option;
                        button.dataset.option = option;
                        button.classList.add('btn-select', 'flex-1', 'py-2', 'rounded-full', 'font-medium', 'text-sm', 'border');

                        if (option === 'Demo Day Pitch') {
                            button.classList.add('bg-indigo-100', 'text-indigo-800', 'hover:bg-indigo-200', 'border-indigo-100');
                        } else if (option === 'Private Pitch') {
                            button.classList.add('bg-purple-100', 'text-purple-800', 'hover:bg-purple-200', 'border-purple-100');
                        } else {
                            button.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300', 'border-gray-200');
                        }

                        button.addEventListener('click', handleSelection);
                        btnContainer.appendChild(button);
                    });

                    card.appendChild(title);
                    card.appendChild(btnContainer);
                    startupListEl.appendChild(card);
                });
            }

            /**
             * Updates the UI to reflect the current selections.
             */
            function updateUI() {
                // Update counters
                demoDayCountEl.textContent = demoDayPitches.size;
                privatePitchCountEl.textContent = privatePitches.size;

                // Update submit button state
                const demoDayCondition = demoDayPitches.size === 10;
                const privatePitchCondition = privatePitches.size === 20;

                if (demoDayCondition && privatePitchCondition && !hasVoted) {
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    submitBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700', 'transform', 'hover:scale-105');
                } else {
                    submitBtn.disabled = true;
                    submitBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                    submitBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700', 'transform', 'hover:scale-105');
                }

                // Update button styles
                const startupCards = document.querySelectorAll('#startup-list > div');
                startupCards.forEach(card => {
                    const startupName = card.dataset.startup;
                    const buttons = card.querySelectorAll('.btn-select');
                    
                    buttons.forEach(btn => {
                        btn.classList.remove('selected-demo', 'selected-private');
                        if (btn.dataset.option === 'Demo Day Pitch') {
                            btn.classList.remove('bg-indigo-500', 'text-white');
                            btn.classList.add('bg-indigo-100', 'text-indigo-800', 'hover:bg-indigo-200');
                        } else if (btn.dataset.option === 'Private Pitch') {
                            btn.classList.remove('bg-purple-500', 'text-white');
                            btn.classList.add('bg-purple-100', 'text-purple-800', 'hover:bg-purple-200');
                        } else {
                            btn.classList.remove('bg-gray-500', 'text-white');
                            btn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                        }

                        if (hasVoted) {
                            btn.disabled = true;
                            btn.classList.add('opacity-50', 'cursor-not-allowed');
                        } else {
                            btn.disabled = false;
                            btn.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                    });

                    if (demoDayPitches.has(startupName)) {
                        const btn = card.querySelector('[data-option="Demo Day Pitch"]');
                        btn.classList.add('selected-demo');
                        btn.classList.remove('bg-indigo-100', 'text-indigo-800');
                    } else if (privatePitches.has(startupName)) {
                        const btn = card.querySelector('[data-option="Private Pitch"]');
                        btn.classList.add('selected-private');
                        btn.classList.remove('bg-purple-100', 'text-purple-800');
                    }
                });
            }

            /**
             * Submits the final selections to Firestore.
             */
            async function handleSubmit() {
                if (hasVoted) {
                    showMessage("You have already submitted your selections.");
                    return;
                }
                if (demoDayPitches.size !== 10 || privatePitches.size !== 20) {
                    showMessage("Please select exactly 10 startups for Demo Day and 20 for Private Pitch.");
                    return;
                }

                try {
                    // Store the final ballot in a new collection keyed by voter name
                    const userVotesRef = doc(db, `/artifacts/${appId}/public/data/final_ballots/${voterName}`);
                    await setDoc(userVotesRef, {
                        demoDayPitches: Array.from(demoDayPitches),
                        privatePitches: Array.from(privatePitches)
                    });

                    hasVoted = true;
                    updateUI();
                    showMessage("Your selections have been submitted successfully!");
                    console.log("Selections submitted:", { demoDayPitches: Array.from(demoDayPitches), privatePitches: Array.from(privatePitches) });

                } catch (e) {
                    console.error("Error submitting selections: ", e);
                    showMessage(`Error submitting selections. Please try again. Error: ${e.message}`);
                }
            }
            
            /**
             * Handles the "Start Voting" button click.
             */
            async function handleStartVoting() {
                voterName = voterNameInputEl.value.trim();
                if (!voterName) {
                    showMessage("Please enter your name to begin.");
                    return;
                }

                nameSectionEl.classList.add('hidden');
                loadingSectionEl.classList.remove('hidden');

                try {
                    // Check if this name has already voted
                    const ballotDocRef = doc(db, `/artifacts/${appId}/public/data/final_ballots/${voterName}`);
                    const ballotDoc = await getDoc(ballotDocRef);
                    
                    if (ballotDoc.exists()) {
                        hasVoted = true;
                        demoDayPitches = new Set(ballotDoc.data().demoDayPitches);
                        privatePitches = new Set(ballotDoc.data().privatePitches);
                        showMessage("You have already submitted your ballot. Your selections are displayed below.");
                    } else {
                        hasVoted = false;
                    }

                    // Show the main application UI
                    loadingSectionEl.classList.add('hidden');
                    appCountersEl.classList.remove('hidden');
                    startupListEl.classList.remove('hidden');
                    submitSectionEl.classList.remove('hidden');
                    voterNameDisplayEl.textContent = voterName;
                    
                    updateUI();

                } catch (e) {
                    console.error("Error checking name: ", e);
                    showMessage(`Error checking name. Please try again. Error: ${e.message}`);
                    nameSectionEl.classList.remove('hidden');
                    loadingSectionEl.classList.add('hidden');
                }
            }

            // Initialization function
            async function init() {
                try {
                    // This version does not use Firebase Auth, but we sign in anonymously to keep the framework happy
                    const auth = getAuth(app);
                    await signInAnonymously(auth);

                } catch (e) {
                    console.error("Error during initialization:", e);
                    showMessage(`Initialization Error: ${e.message}`);
                }
            }
            
            // Initial render and setup
            renderStartups();
            init();
        })();
    </script>
</body>
</html>
